# Red Hat Academy VM Lab

On-demand RHEL virtual machine provisioning with web-based terminal access for students. Integrates with LMS platforms via LTI 1.1 and LTI 1.3.

## Features

- **On-demand VM provisioning** - Students get dedicated 16GB RAM RHEL VMs
- **Web terminal access** - SSH via browser, no VPN required
- **LTI integration** - Works with Canvas, Blackboard, Moodle, Brightspace
- **Dual LTI support** - Both LTI 1.1 (OAuth) and LTI 1.3 (OIDC/JWT)
- **Session persistence** - Students return to the same VM within a course
- **Firewall traversal** - Cloudflare Tunnel exposes services securely
- **Auto-cleanup** - VMs automatically destroyed after session expiry

## Architecture

```
Student → LMS → LTI Server → Orchestration API → libvirt/KVM → RHEL VM
                    ↓                                              ↓
              Cloudflare Tunnel                              ttyd container
                    ↓                                              ↓
              Web Terminal  ←─────────────────────────────────────┘
```

## Prerequisites

### Server Requirements

| Concurrent VMs | RAM | CPU Cores | Storage |
|----------------|-----|-----------|---------|
| 5 students | 96 GB | 24+ | 250 GB SSD |
| 10 students | 192 GB | 48+ | 500 GB SSD |
| 20 students | 384 GB | 96+ | 1 TB NVMe |

### Software Requirements

- **OS**: RHEL 8/9, Rocky Linux 8/9, or Ubuntu 22.04+
- **Virtualization**: KVM/QEMU with libvirt
- **Containers**: Docker and Docker Compose
- **Cloudflare**: Account with Cloudflare Tunnel access

## Quick Start

### 1. Clone and Setup

```bash
cd /opt
git clone <repository> vm-lab
cd vm-lab

# Generate keys and secrets
make setup

# Or manually:
chmod +x scripts/*.sh
./scripts/generate-keys.sh
sudo ./scripts/setup-libvirt-network.sh
```

### 2. Configure Environment

```bash
cp .env.example .env
nano .env  # Edit with your values
```

Required settings:
- `DOMAIN` - Your domain (e.g., `lab.cpcc.edu`)
- `LTI_BASE_URL` - LTI server URL (e.g., `https://lti.lab.cpcc.edu`)
- `CF_TUNNEL_TOKEN` - Cloudflare Tunnel token
- `BASE_QCOW` - Path to your Red Hat Academy QCOW2 image
- LTI secrets - Generated by `make keys`

### 3. Prepare Base VM Image

```bash
# Copy the script to your base VM and run it
scp scripts/prepare-base-image.sh root@basevm:/tmp/
ssh root@basevm /tmp/prepare-base-image.sh

# Copy the SSH public key when prompted
cat lti/keys/id_ed25519.pub
```

### 4. Setup Cloudflare Tunnel

```bash
# Install cloudflared
curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 \
  -o /usr/local/bin/cloudflared
chmod +x /usr/local/bin/cloudflared

# Create tunnel (via dashboard or CLI)
cloudflared tunnel login
cloudflared tunnel create student-labs

# Configure DNS in Cloudflare dashboard:
# - *.lab.yourdomain.com → tunnel
# - lti.yourdomain.com → tunnel
```

### 5. Start Services

```bash
make build
make up

# Check status
make status
make test
```

### 6. Configure LMS

See [LMS Configuration](#lms-configuration) below.

## Directory Structure

```
vm-lab/
├── docker-compose.yml      # Service definitions
├── .env                    # Configuration (create from .env.example)
├── Makefile               # Common commands
├── api/                   # VM Orchestration API
│   ├── main.py
│   ├── Dockerfile
│   └── requirements.txt
├── lti/                   # LTI Server
│   ├── main.py
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── lti13_config.json  # LTI 1.3 platform configs
│   └── keys/              # Generated keys
│       ├── private.pem    # LTI 1.3 signing key
│       ├── public.pem     # LTI 1.3 verification key
│       ├── id_ed25519     # SSH private key
│       └── id_ed25519.pub # SSH public key (add to VMs)
├── scripts/
│   ├── generate-keys.sh
│   ├── setup-libvirt-network.sh
│   └── prepare-base-image.sh
├── cloudflared/
│   └── config.yml
└── init-db.sql            # Database schema
```

## LMS Configuration

### Canvas (LTI 1.1 - Simple)

1. Go to **Course → Settings → Apps → +App**
2. Configuration Type: **By URL**
3. Enter:
   - Consumer Key: `cpcc-canvas`
   - Shared Secret: (from your `.env` file)
   - Config URL: `https://lti.yourdomain.com/lti/config.xml`

### Canvas (LTI 1.3 - Recommended)

1. **Admin → Developer Keys → +Developer Key → +LTI Key**
2. Configure:
   - Redirect URIs: `https://lti.yourdomain.com/lti/launch`
   - OpenID Connect Initiation URL: `https://lti.yourdomain.com/lti/login`
   - Public JWK URL: `https://lti.yourdomain.com/lti/jwks`
3. Add to course via Client ID

### Blackboard (LTI 1.1)

1. **System Admin → Building Blocks → LTI Tool Providers**
2. Register provider domain: `lti.yourdomain.com`
3. Configure:
   - Tool Provider Key: `cpcc-blackboard`
   - Tool Provider Secret: (from your `.env` file)
   - Launch URL: `https://lti.yourdomain.com/lti/launch`

### Moodle (LTI 1.1)

1. **Site Admin → Plugins → External tool → Manage tools**
2. Add:
   - Tool URL: `https://lti.yourdomain.com/lti/launch`
   - Consumer key: `cpcc-moodle`
   - Shared secret: (from your `.env` file)

## API Endpoints

### LTI Server (`https://lti.yourdomain.com`)

| Endpoint | Description |
|----------|-------------|
| `POST /lti/launch` | Main launch (auto-detects LTI version) |
| `GET /lti/login` | LTI 1.3 OIDC initiation |
| `GET /lti/jwks` | LTI 1.3 public keys |
| `GET /lti/config` | LTI 1.3 JSON configuration |
| `GET /lti/config.xml` | LTI 1.1 XML configuration |
| `GET /lti/health` | Health check |

### Orchestration API (`http://lab-api:8000` internal)

| Endpoint | Description |
|----------|-------------|
| `POST /api/provision` | Create new VM session |
| `GET /api/session/by-key/{key}` | Find existing session |
| `DELETE /api/{session_id}` | Destroy session |
| `GET /api/sessions` | List all sessions |
| `POST /api/{session_id}/extend` | Extend session time |
| `GET /api/stats` | System statistics |
| `GET /health` | Health check |

## Operations

### View Logs

```bash
make logs           # All services
make logs-lti       # LTI server only
make logs-api       # API server only
```

### Check Status

```bash
make status         # Container and VM status
make stats          # VM statistics
make test           # Health checks
```

### Database Access

```bash
make db-shell       # PostgreSQL shell
make db-backup      # Create backup
```

### Manual Session Management

```bash
# List running VMs
virsh list

# List ttyd containers
docker ps --filter "name=ttyd-"

# Destroy specific session
curl -X DELETE http://localhost:8000/api/SESSION_ID
```

## Troubleshooting

### VM won't start

```bash
# Check libvirt logs
journalctl -u libvirtd -f

# Check VM definition
virsh dumpxml student-SESSION_ID

# Check base image exists
ls -la /var/lib/libvirt/images/
```

### SSH connection fails

```bash
# Test SSH from API container
docker exec -it lab-api ssh -i /app/keys/id_ed25519 student@VM_IP

# Check if SSH key is in VM
# (VM should have key in /home/student/.ssh/authorized_keys)
```

### LTI launch fails

```bash
# Check LTI server logs
docker logs lti-server -f

# Test LTI health
curl https://lti.yourdomain.com/lti/health

# Verify consumer key is configured
grep LTI11 .env
```

### Cloudflare Tunnel issues

```bash
# Check tunnel status
docker logs cloudflared -f

# Test local connectivity
curl -H "Host: lti.yourdomain.com" http://localhost:80/lti/health
```

## Security Considerations

- **LTI 1.1 secrets** are shared between LMS and tool - keep them secure
- **LTI 1.3** uses public/private keys - more secure, preferred for new setups
- **Session URLs** use random 8-char IDs (2.8 trillion combinations)
- **VMs are isolated** on a private network bridge
- **Sessions auto-expire** after 4 hours (configurable)
- **HTTPS enforced** via Cloudflare Tunnel

## License

Internal use only - Central Piedmont Community College
